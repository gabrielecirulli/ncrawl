// Generated by CoffeeScript 1.3.3
(function() {
  var Queue, Scan, colors, commands, fs, modules, ports, targets, _;

  colors = require('colors');

  fs = require('fs');

  _ = require('underscore');

  commands = require('./commands');

  modules = require('./modules');

  targets = require('./targets');

  Queue = require('./queue');

  ports = require('./ports');

  Scan = require('./scan');

  module.exports = function(options) {
    var completedScans, currentProgress, finish, increment, lastUpdatedProgress, parsedModules, parsedTargets, progress, progressInterval, queue, remainingScans, reporter, scanID, scanTarget, startTime, target, totalModules, totalPorts, totalTargets, _i, _len, _results;
    commands.defaults(options);
    parsedModules = modules(options.modules);
    queue = new Queue(options.operations);
    reporter = options.reporter;
    if (_.isString(reporter)) {
      reporter = require(require.resolve("../reporters/" + options.reporter));
    }
    options = _.extend(options, reporter);
    options.ports = ports(options.ports);
    parsedTargets = targets(options.targets);
    totalTargets = parsedTargets.length;
    totalModules = Object.keys(parsedModules).length;
    totalPorts = options.ports.length;
    if (!options.error) {
      options.error = function(code, msg) {
        throw new Error(msg);
      };
    }
    if (totalTargets === 0) {
      options.error(1, 'No targets selected');
    }
    if (totalModules === 0 && totalPorts === 0) {
      options.error(2, 'No modules or ports selected');
    }
    if (totalTargets === 0 || totalModules === 0 && totalPorts === 0) {
      return;
    }
    if (options.before) {
      options.before({
        totalTargets: totalTargets,
        totalModules: totalModules
      });
    }
    startTime = Date.now();
    increment = (totalModules / totalTargets) * 100 / totalModules;
    currentProgress = 0;
    lastUpdatedProgress = 0;
    completedScans = 0;
    remainingScans = 0;
    scanID = 0;
    progress = function() {
      var elapsed;
      if (completedScans === 0) {
        return;
      }
      elapsed = Date.now() - startTime;
      return options.progress({
        progress: currentProgress,
        elapsed: elapsed,
        eta: elapsed * (totalTargets / completedScans - 1),
        totalScans: totalTargets,
        remainingScans: remainingScans,
        completedScans: completedScans
      });
    };
    if (options.progressInterval) {
      progressInterval = setInterval(progress, options.progressInterval);
    }
    finish = function() {
      clearInterval(progressInterval);
      if (!options.after) {
        return;
      }
      return options.after({
        start: startTime,
        end: Date.now(),
        took: Date.now() - startTime
      });
    };
    scanTarget = options.scanTarget = function(target, callback) {
      var id;
      id = scanID++;
      remainingScans++;
      if (options.queue) {
        options.queue(id, target);
      }
      return queue.add(function(queueDone) {
        return new Scan({
          id: id,
          target: target,
          options: options,
          reporter: new options.Reporter(target, options),
          queueDone: queueDone,
          totalModules: totalModules,
          modules: parsedModules,
          queue: queue,
          done: function() {
            if (callback) {
              callback(this.info, this.results);
            }
            completedScans++;
            currentProgress += increment;
            if (!options.progressInterval && options.progress) {
              progress();
            }
            if (--remainingScans === 0) {
              return finish();
            }
          }
        });
      });
    };
    _results = [];
    for (_i = 0, _len = parsedTargets.length; _i < _len; _i++) {
      target = parsedTargets[_i];
      _results.push(scanTarget(target));
    }
    return _results;
  };

}).call(this);
